import{o as e,w as t,q as a,r,m as s,g as n,j as o,p as i,d as c,F as u,u as d}from"../../../chunks/svelte-vendor.js";import{l,E as p,A as g}from"../../../chunks/audio-engine.js";import{s as m}from"../../../chunks/authStore.js";import"../../../chunks/voice-control.js";const h=new class{supabase;constructor(){this.supabase=m}ensureSupabase(){if(!this.supabase)throw new Error("Supabase not configured - project features unavailable in test mode");return this.supabase}async saveProject(e,t){const{data:a,error:r}=await this.supabase.from("projects").insert({name:e,data:t}).select().single();if(r)throw new Error(`Failed to save project: ${r.message}`);return a}async loadProject(e){const{data:t,error:a}=await this.supabase.from("projects").select("*").eq("id",e).single();if(a)throw new Error(`Failed to load project: ${a.message}`);return t}async listProjects(){const{data:e,error:t}=await this.supabase.from("projects").select("*").order("updated_at",{ascending:!1});if(t)throw new Error(`Failed to list projects: ${t.message}`);return e||[]}async updateProject(e,t,a){const{data:r,error:s}=await this.supabase.from("projects").update({name:t,data:a,updated_at:(new Date).toISOString()}).eq("id",e).select().single();if(s)throw new Error(`Failed to update project: ${s.message}`);return r}async deleteProject(e){const{error:t}=await this.supabase.from("projects").delete().eq("id",e);if(t)throw new Error(`Failed to delete project: ${t.message}`)}async shareProject(e){const{data:t,error:a}=await this.supabase.from("projects").select("share_token, id").eq("id",e).single();if(a)throw new Error(`Failed to fetch project: ${a.message}`);if(t.share_token)return t.share_token;const r=this.generateShareToken(),{error:s}=await this.supabase.from("projects").update({share_token:r,is_public:!0}).eq("id",e);if(s)throw new Error(`Failed to share project: ${s.message}`);return r}async getSharedProject(e){const{data:t,error:a}=await this.supabase.from("projects").select("*").eq("share_token",e).eq("is_public",!0).single();if(a)throw new Error(`Failed to load shared project: ${a.message}`);return t}async uploadFile(e,t){const a=Date.now(),r=e.name.replace(/[^a-zA-Z0-9.-]/g,"_"),{data:{user:s}}=await this.ensureSupabase().auth.getUser();if(!s)throw new Error("User not authenticated");const n=`${s.id}/${a}-${r}`,{data:o,error:i}=await this.ensureSupabase().storage.from("audio-files").upload(n,e,{cacheControl:"3600",upsert:!1});if(i)throw new Error(`Failed to upload file: ${i.message}`);const{error:c}=await this.supabase.from("files").insert({user_id:s.id,project_id:t||null,filename:e.name,storage_path:n,size_bytes:e.size,mime_type:e.type});c&&l.error("Failed to save file metadata:",c);const{data:u}=this.ensureSupabase().storage.from("audio-files").getPublicUrl(n);return u.publicUrl}async getProjectVersions(e){const{data:t,error:a}=await this.supabase.from("project_versions").select("*").eq("project_id",e).order("version_number",{ascending:!1}).limit(50);if(a)throw new Error(`Failed to fetch versions: ${a.message}`);return t||[]}async createProjectVersion(e,t){const{error:a}=await this.ensureSupabase().rpc("create_project_version",{p_project_id:e,p_data:t});if(a)throw new Error(`Failed to create version: ${a.message}`)}async duplicateProject(e){const t=await this.loadProject(e);return await this.saveProject(`${t.name} (copy)`,t.data)}generateShareToken(){const e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}getSupabase(){return this.supabase}},f={audioEngine:null,isPlaying:!1,isRecording:!1,currentTime:0,tempo:120,timeSignature:[4,4],currentProject:null,projectId:null,projectName:"Untitled Project",hasUnsavedChanges:!1,isSaving:!1,lastSaved:null,currentView:"arrangement",selectedTrackId:null,isInitialized:!1,error:null},j=function(){const{subscribe:e,set:r,update:s}=t(f);let n=null;function o(t){const r=a({subscribe:e});r.audioEngine&&(r.audioEngine.setTempo(t),s(e=>({...e,tempo:t,hasUnsavedChanges:!0})))}async function i(){s(e=>({...e,isSaving:!0,error:null}));try{const r=a({subscribe:e});if(!r.audioEngine)throw new Error("Audio engine not initialized");const n={tracks:(t=r.audioEngine).getAllTracks().map(e=>({id:e.id,name:e.name,type:e.type,color:e.color,order:0,settings:{volume:e.getVolume(),pan:e.getPan(),mute:e.isMuted(),solo:e.isSoloed(),recordArm:!1,monitor:!1,frozen:!1,input:"default",output:"master"}})),tempo:t.getTempo(),timeSignature:[4,4],effects:[],clips:[]};let o;return o=r.projectId?await h.updateProject(r.projectId,r.projectName,n):await h.saveProject(r.projectName,n),s(e=>({...e,currentProject:o,projectId:o.id,hasUnsavedChanges:!1,isSaving:!1,lastSaved:new Date})),p.getInstance().emit("project:saved",{projectId:o.id}),{success:!0}}catch(e){const t=e instanceof Error?e.message:"Failed to save project";return s(e=>({...e,isSaving:!1,error:t})),{success:!1,error:t}}var t}function c(){s(e=>({...e,hasUnsavedChanges:!0}))}return{subscribe:e,initializeAudioEngine:async function(){try{const t=g.getInstance({sampleRate:48e3,latencyHint:"interactive",lookAhead:.1});await t.initialize();try{await t.context.resume(),l.info("âœ… Audio engine auto-initialized for testing")}catch(e){l.warn("Auto-resume failed (may still need user interaction):",e)}return s(e=>({...e,audioEngine:t,isInitialized:!0,tempo:t.getTempo()})),function(){const e=p.getInstance();e.on("playback:play",()=>{s(e=>({...e,isPlaying:!0}))}),e.on("playback:stop",()=>{s(e=>({...e,isPlaying:!1}))}),e.on("playback:pause",()=>{s(e=>({...e,isPlaying:!1}))}),e.on("track:created",()=>c()),e.on("track:deleted",()=>c()),e.on("track:updated",()=>c())}(),n||(n=window.setInterval(async()=>{const t=a({subscribe:e});t.hasUnsavedChanges&&t.projectId&&(l.info("Auto-saving project..."),await i())},3e4)),t}catch(e){throw l.error("Failed to initialize audio engine:",e),s(t=>({...t,error:e instanceof Error?e.message:"Failed to initialize audio"})),e}},play:function(){const t=a({subscribe:e});t.audioEngine&&(t.audioEngine.play(),s(e=>({...e,isPlaying:!0})))},stop:function(){const t=a({subscribe:e});t.audioEngine&&(t.audioEngine.stop(),s(e=>({...e,isPlaying:!1})))},pause:function(){const t=a({subscribe:e});t.audioEngine&&(t.audioEngine.pause(),s(e=>({...e,isPlaying:!1})))},setTempo:o,newProject:async function(t){const r=t||"Untitled Project";s(e=>({...e,currentProject:null,projectId:null,projectName:r,hasUnsavedChanges:!1,lastSaved:null}));const n=a({subscribe:e});return n.audioEngine&&n.audioEngine.getAllTracks().forEach(e=>n.audioEngine.removeTrack(e.id)),{success:!0}},saveProject:i,loadProject:async function(t){try{const r=await h.loadProject(t);s(e=>({...e,currentProject:r,projectId:r.id,projectName:r.name,hasUnsavedChanges:!1,lastSaved:new Date(r.updated_at)}));const n=a({subscribe:e});return n.audioEngine&&r.data&&(await async function(e,t){if(e.getAllTracks().forEach(t=>e.removeTrack(t.id)),t.tracks)for(const a of t.tracks){const t=e.addTrack({id:a.id,name:a.name,type:a.type,color:a.color});a.settings&&(t.setVolume(a.settings.volume),t.setPan(a.settings.pan),t.setMute(a.settings.mute),t.setSolo(a.settings.solo))}}(n.audioEngine,r.data),r.data.tempo&&o(r.data.tempo)),p.getInstance().emit("project:loaded",{projectId:r.id}),{success:!0}}catch(e){const t=e instanceof Error?e.message:"Failed to load project";return s(e=>({...e,error:t})),{success:!1,error:t}}},setProjectName:function(e){s(t=>({...t,projectName:e,hasUnsavedChanges:!0}))},setView:function(e){s(t=>({...t,currentView:e}))},selectTrack:function(e){s(t=>({...t,selectedTrackId:e})),p.getInstance().emit("track:selected",{trackId:e})},clearError:function(){s(e=>({...e,error:null}))},cleanup:function(){n&&(clearInterval(n),n=null);const t=a({subscribe:e});t.audioEngine&&t.audioEngine.dispose()}}}();e(j,e=>e.audioEngine),e(j,e=>e.isPlaying),e(j,e=>e.currentProject);const w=e(j,e=>e.hasUnsavedChanges),v=e(j,e=>e.projectName);function b(e,t){e.component(e=>{var t;function a(e){o(t??={},"$hasUnsavedChanges",w)&&(e.preventDefault(),e.returnValue="")}r(()=>{"undefined"!=typeof window&&window.removeEventListener("beforeunload",a)});let u,l=!0;function p(e){s(e,e=>{e.title(e=>{e.push(`<title>${n(o(t??={},"$projectName",v))} - DAWG AI</title>`)})}),e.push("\x3c!--[!--\x3e"),e.push("\x3c!--[--\x3e"),e.push('<div class="flex items-center justify-center min-h-screen">'),i(e,"div",303,1),e.push('<div class="text-center">'),i(e,"div",304,2),e.push('<div class="spinner mb-4 svelte-18lm2wj">'),i(e,"div",305,3),e.push("</div>"),c(),e.push(' <p class="text-white/70">'),i(e,"p",306,3),e.push("Initializing audio engine...</p>"),c(),e.push("</div>"),c(),e.push("</div>"),c(),e.push("\x3c!--]--\x3e"),e.push("\x3c!--]--\x3e "),e.push("\x3c!--[!--\x3e"),e.push("\x3c!--]--\x3e")}do{l=!0,u=e.copy(),p(u)}while(!l);e.subsume(u),t&&d(t)},b)}b[u]="src/routes/daw/+page.svelte",b.render=function(){throw new Error("Component.render(...) is no longer valid in Svelte 5. See https://svelte.dev/docs/svelte/v5-migration-guide#Components-are-no-longer-classes for more information")};export{b as default};
